<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<title>Workaround For AD PSDrive Bug In Server 2019 - Adventures in Tech</title>
<meta name="description" content="PSPath to the rescue">
<meta name="viewport" content="width=device-width, initial-scale=1">



  <meta name="generator" content="Hugo 0.55.6" />
  
<meta itemprop="name" content="Workaround For AD PSDrive Bug In Server 2019">
<meta itemprop="description" content="PSPath to the rescue">


<meta itemprop="datePublished" content="2019-07-16T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-07-16T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="391">



<meta itemprop="keywords" content="powershell," />

  <meta property="og:title" content="Workaround For AD PSDrive Bug In Server 2019" />
<meta property="og:description" content="PSPath to the rescue" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.dvolve.net/blog/2019/07/workaround-for-ad-psdrive-bug-in-server-2019/" />
<meta property="article:published_time" content="2019-07-16T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-07-16T00:00:00&#43;00:00"/>

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Workaround For AD PSDrive Bug In Server 2019"/>
<meta name="twitter:description" content="PSPath to the rescue"/>
<meta name="twitter:site" content="@rmbolger"/>

  

  <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/solarized-dark.min.css">
  
    
      <link rel="stylesheet" href="/css/normalize.css">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.1.0/css/flag-icon.min.css">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css">
      <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.9.0/css/all.css" integrity="sha384-i1LQnF23gykqWXg6jxC2ZbCbUMxyw5gLZY6UiUS98LYV5unm8GWmfkIS6jqJfb4E" crossorigin="anonymous">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css" />
      <link rel="stylesheet" href="/css/main.min.css">
      <link rel="stylesheet" href="/css/add-on.css">
    
  
  
  
  
  
</head>

  <body>
    
<header id="site-header">
  <nav id="site-nav">
    <h1 class="nav-title">
      <a href="/">
        
          
            Blog
          
        
      </a>
    </h1>
    <menu id="site-nav-menu" class="flyout-menu">
      
        <a href="/" class="link"><i class="fas fa-home">&nbsp;</i>Home</a>
      
        <a href="/about/" class="link"><i class="far fa-id-card">&nbsp;</i>About</a>
      
        <a href="/blog/" class="link"><i class="far fa-newspaper">&nbsp;</i>Blog</a>
      
      
      

    </menu>
    

    
    
    <a href="#site-nav" class="nav-toggle"><i class="fas fa-bars fa-2x"></i></a>
  </nav>
  
  
</header>

    <div id="wrapper">
      <section id="site-intro">
  <a href="/"><img src="/img/main/logo.jpg" class="circle" width="" alt="Ryan Bolger" /></a>
  <header>
    <h1>Ryan Bolger</h1>
  </header>
  <main>
    <p>Adventures In Tech</p>
  </main>
  
    <footer>
      <ul class="social-icons">
        

        <li><a href="//github.com/rmbolger" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>


<li><a href="//serverfault.com/users/1584/?tab=profile" target="_blank" rel="noopener" title="Server Fault" class="fab fa-stack-exchange"></a></li>









<li><a href="//linkedin.com/in/rmbolger" target="_blank" rel="noopener" title="LinkedIn" class="fab fa-linkedin"></a></li>















<li><a href="//twitter.com/rmbolger" target="_blank" rel="noopener" title="Twitter" class="fab fa-twitter"></a></li>








<li><a href="//keybase.io/rmbolger" target="_blank" rel="noopener" title="keybase" class="fab fa-keybase"></a></li>



      </ul>
    </footer>
  
</section>

      <main id="site-main">
        <article class="post">
  <header>
  <div class="title">
    
        <h2><a href="/blog/2019/07/workaround-for-ad-psdrive-bug-in-server-2019/">Workaround For AD PSDrive Bug In Server 2019</a></h2>
    
    
        <p>PSPath to the rescue</p>
    
</div>
  <div class="meta">
    <time class="published" datetime="2019-07-16 00:00:00 &#43;0000 UTC">
      July 16, 2019
    </time>
    <span class="author">Ryan Bolger</span>
    
  </div>
</header>

  <section id="social-share">
    





  </section>
  

  <div class="content">
    

<h2 id="tl-dr">TL;DR</h2>

<p>Until Microsoft fixes the bug with the AD PSDrive provider, use the fully qualified PSPath to the object instead of the &ldquo;AD:<DN>&rdquo; PSDrive path like this:</p>

<pre><code class="language-powershell">$DN = (Get-ADUser jdoe).distinguishedName
$objectPath = &quot;Microsoft.ActiveDirectory.Management.dll\ActiveDirectory:://RootDSE/$DN&quot;
Get-Acl -Path $objectPath
</code></pre>

<h2 id="the-story">The Story</h2>

<p>I was browsing <a href="https://www.reddit.com/r/PowerShell">r/PowerShell</a> recently and came across a thread from someone who had run into a PowerShell bug after upgrading to Windows Server 2019 (1809). The user was attempting to run <code>Get-Acl</code> against an AD object using the object&rsquo;s distinguished name like this:</p>

<pre><code class="language-powershell">$DN = (Get-ADUser jdoe).distinguishedName
$ACL = Get-Acl -Path &quot;AD:\$DN&quot;
</code></pre>

<p>The code works just fine in Server 2016 and earlier. But the same code throws an error in Server 2019 and reportedly Windows 10 (1903) as well.</p>

<pre><code class="language-plaintext">Get-Acl : The object name has bad syntax
At line:1 char:8
+ $ACL = Get-Acl -Path &quot;AD:\$DN&quot;
+        ~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (\\RootDSE\CN=Do...C=example,DC=com:String) [Get-Acl], ADException
    + FullyQualifiedErrorId : ADProvider:ItemExists::ADError,Microsoft.PowerShell.Commands.GetAclCommand
</code></pre>

<p>The problem is this particular user&rsquo;s DN had an escaped comma in it because the CN value was set to &ldquo;Doe, Jane&rdquo;. Commas are allowed in object names in AD, but they tend to cause all sorts of problems with LDAP path parsing code due to the escaping. The resulting DN of the object looks something like this:</p>

<pre><code class="language-plaintext">CN=Doe\, Jane,CN=Users,DC=example,DC=com
</code></pre>

<p>Historically, the Windows native Active Directory PowerShell cmdlets and PSDrive provider have no issues dealing with this. But apparently a bug crept into the latest releases. It should be noted that the bug exists with any cmdlet that depends on the Active Directory PSDrive provider. <code>Get-Acl</code> just happens to be the one this user was using. But it also affects something as simple as <code>Get-Item</code>.</p>

<h2 id="the-workaround">The Workaround</h2>

<p>One of the things I tried while poking around this bug looking for a workaround was running <code>Get-ChildItem</code> against the parent container and then running <code>Get-Acl</code> against the <code>PSPath</code> parameter of the results like this.</p>

<pre><code class="language-powershell">Get-ChildItem &quot;CN=Users,DC=example,DC=com&quot; | ForEach-Object { Get-Acl -Path $_.PSPath }
</code></pre>

<p>To my pleasant surprise, it worked without issue. So I took a look at the format of the PSPath for these objects and found this for my problematic test user.</p>

<pre><code class="language-plaintext">Microsoft.ActiveDirectory.Management.dll\ActiveDirectory:://RootDSE/CN=Doe\, Jane,CN=Users,DC=example,DC=com
</code></pre>

<p>We can generalize this out to a somewhat ugly (but at least usable) path prefix for any DN and work it into the original code like this.</p>

<pre><code class="language-powershell">$DN = (Get-ADUser jdoe).distinguishedName
$objectPath = &quot;Microsoft.ActiveDirectory.Management.dll\ActiveDirectory:://RootDSE/$DN&quot;
$ACL = Get-Acl -Path $objectPath
</code></pre>

  </div>
  <footer>
    <ul class="stats">
  
    
    
      <li class="categories">
        <ul>
          
            
            <li><a class="article-category-link" href="https://www.dvolve.net/categories/active-directory">Active Directory</a></li>
          
        </ul>
      </li>
    
  
  
    
    
      <li class="tags">
        <ul>
          
            
            <li><a class="article-category-link" href="https://www.dvolve.net/tags/powershell">powershell</a></li>
          
        </ul>
      </li>
    
  
</ul>

  </footer>
</article>
<article class="post">
  

</article>
<div class="pagination">
  
    <a href="/blog/2019/06/infoblox-and-ms-management-permissions/" class="button big previous"><i class="fas fa-angle-left"></i> Infoblox and MS Management Permissions</a>
  
  
    <a href="/blog/2019/08/new-module-pwnedpasscheck/" class="button big next">New Module: PwnedPassCheck <i class="fas fa-angle-right"></i></a>
  
</div>


      </main>
      <section id="site-sidebar">
  <section id="recent-posts">
    <header>
      <h1>Recent posts</h1>
    </header>
    
    <article class="mini-post">
      <section>
        

      </section>
      <header>
        <h1><a href="/blog/2019/08/new-module-pwnedpasscheck/">New Module: PwnedPassCheck</a></h1>
        <time class="published" datetime="">August 13, 2019</time>
      </header>
    </article>
    
    <article class="mini-post">
      <section>
        

      </section>
      <header>
        <h1><a href="/blog/2019/07/workaround-for-ad-psdrive-bug-in-server-2019/">Workaround For AD PSDrive Bug In Server 2019</a></h1>
        <time class="published" datetime="">July 16, 2019</time>
      </header>
    </article>
    
    <article class="mini-post">
      <section>
        

      </section>
      <header>
        <h1><a href="/blog/2019/06/infoblox-and-ms-management-permissions/">Infoblox and MS Management Permissions</a></h1>
        <time class="published" datetime="">June 27, 2019</time>
      </header>
    </article>
    
    <article class="mini-post">
      <section>
        

      </section>
      <header>
        <h1><a href="/blog/2019/06/posh-acme-3.5.0/">Posh-ACME 3.5.0</a></h1>
        <time class="published" datetime="">June 21, 2019</time>
      </header>
    </article>
    
    <article class="mini-post">
      <section>
        

      </section>
      <header>
        <h1><a href="/blog/2019/04/posh-ibwapi-3.0.0/">Posh-IBWAPI 3.0.0</a></h1>
        <time class="published" datetime="">April 20, 2019</time>
      </header>
    </article>
    
    
      <a href="/blog/" class="button">See more</a>
    
  </section>

  


  
</section>

      <footer id="site-footer">
  
  <p class="copyright">
    
      &copy; 2019
      
        Ryan Bolger
      
    .
    Powered by <a href="//gohugo.io" target="_blank" rel="noopener">Hugo</a>
  </p>
</footer>
<a id="back-to-top" href="#" class="fas fa-arrow-up fa-2x"></a>

      
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/xml.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/css.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/javascript.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/ini.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/powershell.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/cs.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/python.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/plaintext.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js"></script>
  <script src=/js/util.js></script>
  <script src=/js/main.js></script>
  <script src=/js/add-on.js></script>
  


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-77433451-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


    </div>
  </body>
</html>
