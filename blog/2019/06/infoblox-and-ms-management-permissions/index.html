<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<title>Infoblox and MS Management Permissions - Adventures in Tech</title>
<meta name="viewport" content="width=device-width, initial-scale=1">



  <meta name="generator" content="Hugo 0.59.0" />
  <meta itemprop="name" content="Infoblox and MS Management Permissions">
<meta itemprop="description" content="How to avoid using Domain Admin">


<meta itemprop="datePublished" content="2019-06-27T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-06-27T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1127">



<meta itemprop="keywords" content="powershell," />

  <meta property="og:title" content="Infoblox and MS Management Permissions" />
<meta property="og:description" content="How to avoid using Domain Admin" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.dvolve.net/blog/2019/06/infoblox-and-ms-management-permissions/" />
<meta property="article:published_time" content="2019-06-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-06-27T00:00:00+00:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Infoblox and MS Management Permissions"/>
<meta name="twitter:description" content="How to avoid using Domain Admin"/>
<meta name="twitter:site" content="@rmbolger"/>

  

  <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/solarized-dark.min.css">
  
    
      <link rel="stylesheet" href="/css/normalize.css">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css">
      <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.9.0/css/all.css" integrity="sha384-i1LQnF23gykqWXg6jxC2ZbCbUMxyw5gLZY6UiUS98LYV5unm8GWmfkIS6jqJfb4E" crossorigin="anonymous">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css" />
      
      
      <link rel="stylesheet" href="/css/main.min.def756f4cd28354005a37cedc94c36d695bb1b0271e40edf1acf67d865b9ff70.css" integrity="sha256-3vdW9M0oNUAFo3ztyUw21pW7GwJx5A7fGs9n2GW5/3A=">
      <link rel="stylesheet" href="/css/add-on.css">
    
  
  
  
  
    
  
</head>

  <body>
    
<header id="site-header">
  <nav id="site-nav">
    <h1 class="nav-title">
      <a href="/">
        
          
            Blog
          
        
      </a>
    </h1>
    <menu id="site-nav-menu" class="flyout-menu">
      
        
          
          
            <a href="/" class="link"><i class='fa fa-home'></i> Home</a>
          
        
      
        
          
          
            <a href="/about/" class="link"><i class='far fa-id-card'></i> About</a>
          
        
      
        
          
          
            <a href="/blog/" class="link"><i class='far fa-newspaper'></i> Blog</a>
          
        
      
        
          
          
            <a href="/categories/" class="link"><i class='fas fa-sitemap'></i> Categories</a>
          
        
      
      
      

    </menu>
    

    
    
    <a href="#site-nav" class="nav-toggle"><i class="fas fa-bars fa-2x"></i></a>
  </nav>
  
  
</header>

    <div id="wrapper">
      <section id="site-intro">
  <a href="/"><img src="/img/main/logo.jpg" class="circle" width="" alt="Ryan Bolger" /></a>
  <header>
    <h1>Ryan Bolger</h1>
  </header>
  <main>
    <p>Adventures In Tech</p>
  </main>
  
    <footer>
      <ul class="socnet-icons">
        

        <li><a href="//github.com/rmbolger" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>


<li><a href="//serverfault.com/users/1584/?tab=profile" target="_blank" rel="noopener" title="Server Fault" class="fab fa-stack-exchange"></a></li>









<li><a href="//linkedin.com/in/rmbolger" target="_blank" rel="noopener" title="LinkedIn" class="fab fa-linkedin"></a></li>















<li><a href="//twitter.com/rmbolger" target="_blank" rel="noopener" title="Twitter" class="fab fa-twitter"></a></li>








<li><a href="//keybase.io/rmbolger" target="_blank" rel="noopener" title="keybase" class="fab fa-keybase"></a></li>



      </ul>
    </footer>
  
</section>

      <main id="site-main">
        <article class="post">
  <header>
  <div class="title">
    
        <h2><a href="/blog/2019/06/infoblox-and-ms-management-permissions/">Infoblox and MS Management Permissions</a></h2>
    
    
        <p>How to avoid using Domain Admin</p>
    
</div>
  <div class="meta">
    <time class="published" datetime="2019-06-27 00:00:00 &#43;0000 UTC">
      June 27, 2019
    </time>
    <span class="author">Ryan Bolger</span>
    
  </div>
</header>

  <section id="socnet-share">
    





  </section>
  

  <div class="content">
    

<p>The NIOS documentation lacks great instructions for granting least-privilege access to use the various MS Management components. As a former Active Directory admin, that bugs me because people get frustrated and end up giving service accounts Domain Admin permissions just to get things working. This post will lay out the necessary permissions for each component and provide PowerShell examples on how to apply them easily.</p>

<p><em>Warning: I&rsquo;ve tested these permissions and examples against NIOS 8.4 and Windows Server 2008 R2 through 2019. Your mileage may vary if your environment doesn&rsquo;t fit those characteristics.</em></p>

<h1 id="prerequisites">Prerequisites</h1>

<p>DNS and DHCP management don&rsquo;t require targetting domain controllers or even domain joined servers. But it is the most common configuration so our examples will reflect that assumption. If you&rsquo;re targetting a non-domain joined server, you&rsquo;ll need to change the user/group references accordingly and modify the PowerShell commands to use their non-AD equivalents.</p>

<p>Infoblox allows you to use a separate service account for each component, but most organizations choose to use one account for simplicity. So we&rsquo;ll do the same here with a standard AD user account called <code>svc-infoblox</code>.</p>

<p>Most of these components have the choice to be configured in &ldquo;Read-only&rdquo; or &ldquo;Read/Write&rdquo; mode. For organizations who want to use the features in Read-only mode, I still usually suggest granting the permissions necessary for Read/Write in case they change their mind later. Ironically, it also tends to be harder to grant read-only permissions for these services. The examples here will assume Read/Write mode.</p>

<p>In my testing, no manual changes to the Windows default firewall settings were needed. However, if you have group policy or external firewalls locking things down, you&rsquo;ll likely need to open things like the dynamic RPC port range between the managing grid member and the target server. See the <a href="https://docs.infoblox.com/display/nios84/Deployment+Guidelines">Deployment Guidelines</a> doc page for details.</p>

<h1 id="dns">DNS</h1>




  
    
    
    
    
  
  
  
  
  
  
  
  
  <div class="fancybox">
    <a data-fancybox="" href="/img/2019/06/dns-toggles.png" data-caption="DNS Toggleable Options"><img src="/img/2019/06/dns-toggles.png"></a>
    <div class="caption">DNS Toggleable Options</div>
  </div>



<h2 id="synchronize-data">Synchronize Data</h2>

<p>This is the core ability to synchronize zone and record data. All we need is membership in <code>DnsAdmins</code>.</p>

<pre><code class="language-powershell">Get-ADGroup 'DnsAdmins' | Add-ADGroupMember -Members (Get-ADUser 'svc-infoblox')
</code></pre>

<h2 id="monitor-and-control-dns-services">Monitor and control DNS Services</h2>

<p>This adds the ability to see the status of and start/stop the DNS service on the target machine. It requires full control on the local service control manager and DNS service. We&rsquo;ll give the permissions to the DnsAdmins group because our service account is already a member.</p>

<p>Make sure to run these on the target server.</p>

<pre><code class="language-powershell"># Full control on SCManager for DnsAdmins
$scmSDDL = (&amp;sc.exe sdshow scmanager)[1]
$DnsAdminsSID = (Get-ADGroup DnsAdmins).SID.ToString()
$newSDDL = $scmSDDL.Insert(2, &quot;(A;;KA;;;$DnsAdminsSID)&quot;)
&amp;sc.exe sdset scmanager $newSDDL

# Full control on on DNS service for DnsAdmins
$dnsSDDL = (&amp;sc.exe sdshow dns)[1]
$DnsAdminsSID = (Get-ADGroup DnsAdmins).SID.ToString()
$newSDDL = $dnsSDDL.Insert(2, &quot;(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$DnsAdminsSID)&quot;)
&amp;sc.exe sdset dns $newSDDL
</code></pre>

<p><strong>Windows Server 2016 and later</strong> adds an additional hurdle for controlling services from a non-admin account as described in <a href="https://support.microsoft.com/en-us/help/4457739/blocking-remote-callers-from-starting-or-stopping-services-when-they-a">KB 4457739</a>. We need to exempt the DNS service from the new protection.</p>

<pre><code class="language-powershell">$keyName = 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurePipeServers\SCM'
$valName = 'RemoteAccessCheckExemptionList'
$key = Get-Item $keyName
$values = $key.GetValue($valName)
if ('dns' -notin $values) {
    $values += 'dns'
    Set-ItemProperty $keyName $valName $values -Type MultiString
}
</code></pre>

<h2 id="synchronize-dns-reporting-data">Synchronize DNS Reporting Data</h2>

<p><strong>Important</strong>: <em>This feature is only compatible with Windows Server 2012 R2 with <a href="https://support.microsoft.com/en-us/help/2919355/windows-rt-8-1-windows-8-1-and-windows-server-2012-r2-update-april-201">KB 2919355</a> or Server 2016 and later. So make sure it&rsquo;s disabled on anything earlier. See the &ldquo;Synchronizing DNS Reporting Data&rdquo; section in <a href="https://docs.infoblox.com/display/nios84/Configuring+Grid+Properties+for+Managing+Microsoft+Servers">the docs</a> for more details.</em></p>

<p>We need the ability to read the DNS specific event logs. So we&rsquo;ll add the service account to <code>Event Log Readers</code>.</p>

<pre><code class="language-powershell">Get-ADGroup 'Event Log Readers' | Add-ADGroupMember -Members (Get-ADUser 'svc-infoblox')
</code></pre>

<h1 id="dhcp">DHCP</h1>




  
    
    
    
    
  
  
  
  
  
  
  
  
  <div class="fancybox">
    <a data-fancybox="" href="/img/2019/06/dhcp-toggles.png" data-caption="DHCP Toggleable Options"><img src="/img/2019/06/dhcp-toggles.png"></a>
    <div class="caption">DHCP Toggleable Options</div>
  </div>



<h2 id="synchronize-data-1">Synchronize Data</h2>

<p>This is the core ability to synchronize the scope data. All we need is membership in <code>DHCP Administrators</code>.</p>

<pre><code class="language-powershell">Get-ADGroup 'DHCP Administrators' | Add-ADGroupMember -Members (Get-ADUser 'svc-infoblox')
</code></pre>

<h2 id="monitor-and-control-dhcp-services">Monitor and control DHCP Services</h2>

<p>This adds the ability to see the status of and start/stop the DHCP service on the target machine. It requires full control on the local service control manager and DHCP service. We&rsquo;ll give the permissions to the DHCP Administrators group because our service account is already a member.</p>

<p>Make sure to run these on the target server.</p>

<pre><code class="language-powershell"># Full control on SCManager for DHCP Administrators
$scmSDDL = (&amp;sc.exe sdshow scmanager)[1]
$DhcpAdminsSID = (Get-ADGroup 'DHCP Administrators').SID.ToString()
$newSDDL = $scmSDDL.Insert(2, &quot;(A;;KA;;;$DhcpAdminsSID)&quot;)
&amp;sc.exe sdset scmanager $newSDDL

# Full control on on DNS service for DnsAdmins
$dhcpSDDL = (&amp;sc.exe sdshow dhcpserver)[1]
$DhcpAdminsSID = (Get-ADGroup 'DHCP Administrators').SID.ToString()
$newSDDL = $dhcpSDDL.Insert(2, &quot;(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$DhcpAdminsSID)&quot;)
&amp;sc.exe sdset dhcpserver $newSDDL
</code></pre>

<p><strong>Windows Server 2016 and later</strong> adds an additional hurdle for controlling services from a non-admin account as described in <a href="https://support.microsoft.com/en-us/help/4457739/blocking-remote-callers-from-starting-or-stopping-services-when-they-a">KB 4457739</a>. We need to exempt the DHCP service from the new protection.</p>

<pre><code class="language-powershell">$keyName = 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurePipeServers\SCM'
$valName = 'RemoteAccessCheckExemptionList'
$key = Get-Item $keyName
$values = $key.GetValue($valName)
if ('dhcpserver' -notin $values) {
    $values += 'dhcpserver'
    Set-ItemProperty $keyName $valName $values -Type MultiString
}
</code></pre>

<h1 id="active-directory-sites">Active Directory Sites</h1>




  
    
    
    
    
  
  
  
  
  
  
  
  
  <div class="fancybox">
    <a data-fancybox="" href="/img/2019/06/adsites-basic.png" data-caption="Active Directory Sites Basic Options"><img src="/img/2019/06/adsites-basic.png"></a>
    <div class="caption">Active Directory Sites Basic Options</div>
  </div>



<p>If you plan to use LDAP over SSL (LDAPS), make sure your domain controllers have valid certificates. If the certificates are from an internal PKI infrastructure, make sure the CA certificate has been uploaded to Infoblox as well.</p>




  
    
    
    
    
  
  
  
  
  
  
  
  
  <div class="fancybox">
    <a data-fancybox="" href="/img/2019/06/adsites-advanced.png" data-caption="Active Directory Sites Basic Options"><img src="/img/2019/06/adsites-advanced.png"></a>
    <div class="caption">Active Directory Sites Basic Options</div>
  </div>



<p>Make sure &ldquo;Default IP site link&rdquo; is set to a real site link in your environment even if you don&rsquo;t plan to create sites directly from Infoblox.</p>

<p><strong>Important:</strong> Infoblox will only synchronize sites/subnets with the DC holding the PDC emulator (PDCe) FSMO role. In a multi-domain forest, you should only target the PDCe in the root domain. Some organizations also choose to configure a second DC which FSMO roles would be transferred to in a DR situation. Infoblox will simply ignore it until it becomes the PDCe.</p>

<h2 id="permissions-for-subnets">Permissions for Subnets</h2>

<p>These permissions will allow Infoblox to assign/unassign subnets to/from existing sites.</p>

<p><strong>CN=Subnets,CN=Sites,&lt;Configuration Naming Context&gt;</strong></p>

<ul>
<li>Applies to: This object only

<ul>
<li>Create Subnet objects</li>
<li>Delete Subnet objects</li>
</ul></li>
<li>Applies to: Descendant subnet objects

<ul>
<li>Read all properties</li>
<li>Write all properties</li>
<li>Delete</li>
<li>Delete subtree</li>
</ul></li>
</ul>

<p>PowerShell example:</p>

<pre><code class="language-powershell">$cfgContext = (Get-ADRootDSE).configurationNamingContext
$target = &quot;AD\svc-infoblox&quot;   # group or user reference
&amp;dsacls.exe &quot;CN=Subnets,CN=Sites,$cfgContext&quot; /G &quot;$($target):CCDC;subnet&quot;
&amp;dsacls.exe &quot;CN=Subnets,CN=Sites,$cfgContext&quot; /I:S /G &quot;$($target):RPWPSDDT;;subnet&quot;
</code></pre>

<h2 id="permissions-for-sites">Permissions for Sites</h2>

<p>These permissions will allow Infoblox to create/delete/rename site objects. On creation, the new site will be associated with the &ldquo;Default IP site link&rdquo; mentioned earlier. In these examples, we&rsquo;ll assume that is <code>DEFAULTIPSITELINK</code>.</p>

<p><strong>CN=Sites,&lt;Configuration Context&gt;</strong></p>

<ul>
<li>Applies to: This object only

<ul>
<li>Create Site objects</li>
<li>Delete Site objects</li>
</ul></li>
<li>Applies to: Descendant Site objects

<ul>
<li>Read all properties</li>
<li>Write all properties</li>
<li>Delete</li>
<li>Delete subtree</li>
<li>Create all child objects</li>
</ul></li>
</ul>

<p><strong>CN=&lt;Default SiteLink&gt;CN=IP,CN=Inter-Site Transports,CN=Sites,&lt;Configuration Context&gt;</strong></p>

<ul>
<li>Read/Write siteList</li>
</ul>

<p>PowerShell example:</p>

<pre><code class="language-powershell">$cfgContext = (Get-ADRootDSE).configurationNamingContext
$target = &quot;AD\svc-infoblox&quot;   # group or user reference
$defaultSiteLink = &quot;CN=DEFAULTIPSITELINK,CN=IP,CN=Inter-Site Transports,CN=Sites,$cfgContext&quot;
&amp;dsacls.exe &quot;CN=Sites,$cfgContext&quot; /G &quot;$($target):CCDC;site&quot;
&amp;dsacls.exe &quot;CN=Sites,$cfgContext&quot; /I:S /G &quot;$($target):RPWPSDDTCCLCRC;;site&quot;
&amp;dsacls.exe $defaultSiteLink /G &quot;$($target):RPWP;siteList&quot;
</code></pre>

<h1 id="network-users">Network Users</h1>




  
    
    
    
    
  
  
  
  
  
  
  
  
  <div class="fancybox">
    <a data-fancybox="" href="/img/2019/06/network-users.png" data-caption="Network Users Options"><img src="/img/2019/06/network-users.png"></a>
    <div class="caption">Network Users Options</div>
  </div>



<p>For this, Infoblox is just reading the Security event log on the target domain controller. So we need membership in <code>Event Log Readers</code>.</p>

<pre><code class="language-powershell">Get-ADGroup 'Event Log Readers' | Add-ADGroupMember -Members (Get-ADUser 'svc-infoblox')
</code></pre>

  </div>
  <footer>
    <ul class="stats">
  
    
    
      <li class="categories">
        <ul>
          
            
            <li><a class="article-category-link" href="https://www.dvolve.net/categories/infoblox">Infoblox</a></li>
          
        </ul>
      </li>
    
  
  
    
    
      <li class="tags">
        <ul>
          
            
            <li><a class="article-category-link" href="https://www.dvolve.net/tags/powershell">powershell</a></li>
          
        </ul>
      </li>
    
  
</ul>

  </footer>
</article>


<div class="pagination">
  
    <a href="/blog/2019/06/posh-acme-3.5.0/" class="button"><div class="previous"><div>Posh-ACME 3.5.0</div></div></a>
  
  
    <a href="/blog/2019/07/workaround-for-ad-psdrive-bug-in-server-2019/" class="button"><div class="next"><div>Workaround For AD PSDrive Bug In Server 2019</div></div></a>
  
</div>


      </main>
      <section id="site-sidebar">
  
  <section id="recent-posts">
    <header>
      <h1>Recent posts</h1>
    </header>
    
    <article class="mini-post">
      <section>
        

      </section>
      <header>
        <h1><a href="/blog/2019/11/posh-acme-3.10.0/">Posh-ACME 3.10.0</a></h1>
        <time class="published" datetime="">November 6, 2019</time>
      </header>
    </article>
    
    <article class="mini-post">
      <section>
        

      </section>
      <header>
        <h1><a href="/blog/2019/10/posh-acme-3.9.0/">Posh-ACME 3.9.0</a></h1>
        <time class="published" datetime="">October 26, 2019</time>
      </header>
    </article>
    
    <article class="mini-post">
      <section>
        

      </section>
      <header>
        <h1><a href="/blog/2019/10/posh-ibcli-1.3.0/">Posh-IBCLI 1.3.0</a></h1>
        <time class="published" datetime="">October 23, 2019</time>
      </header>
    </article>
    
    <article class="mini-post">
      <section>
        

      </section>
      <header>
        <h1><a href="/blog/2019/09/posh-acme-3.8.0/">Posh-ACME 3.8.0</a></h1>
        <time class="published" datetime="">September 27, 2019</time>
      </header>
    </article>
    
    <article class="mini-post">
      <section>
        

      </section>
      <header>
        <h1><a href="/blog/2019/09/posh-acme-3.7.0/">Posh-ACME 3.7.0</a></h1>
        <time class="published" datetime="">September 18, 2019</time>
      </header>
    </article>
    
    
      <a href="/blog/" class="button">See more</a>
    
  </section>
  

  
    
      <section id="categories">
        <header>
          <h1><a href="/categories">Categories</a></h1>
        </header>
        <ul>
          
            
          
          
          <li>
            
              <a href="/categories/posh-acme/">posh-acme<span class="count">6</span></a>
            
          
          <li>
            
              <a href="/categories/active-directory/">active-directory<span class="count">2</span></a>
            
          
          <li>
            
              <a href="/categories/posh-ibwapi/">posh-ibwapi<span class="count">2</span></a>
            
          
          <li>
            
              <a href="/categories/pwnedpasscheck/">pwnedpasscheck<span class="count">2</span></a>
            
          
          <li>
            
              <a href="/categories/infoblox/">infoblox<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/posh-ibcli/">posh-ibcli<span class="count">1</span></a>
            
          
          </li>
        </ul>
      </section>
    
  


  
</section>

      <footer id="site-footer">
  
  <p class="copyright">
    
      &copy; 2019
      
        Ryan Bolger
      
    . <br>
    Theme: <a href='https://github.com/pacollins/hugo-future-imperfect-slim' target='_blank' rel='noopener'>Hugo Future Imperfect Slim</a><br>A <a href='https://html5up.net/future-imperfect' target='_blank' rel='noopener'>HTML5 UP port</a> | Powered by <a href='https://gohugo.io/' title='0.59.0' target='_blank' rel='noopener'>Hugo</a>
  </p>
</footer>
<a id="back-to-top" href="#" class="fas fa-arrow-up fa-2x"></a>

      
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/xml.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/css.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/javascript.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/ini.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/powershell.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/cs.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/python.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/plaintext.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js"></script>
  <script src=/js/util.js></script>
  <script src=/js/main.js></script>
  <script src=/js/add-on.js></script>
  




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-77433451-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


    </div>
  </body>
</html>
